<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SPZ WebXR Viewer</title>
    <style>
      :root {
        --bg: #06080f;
        --panel: rgba(11, 18, 30, 0.82);
        --line: rgba(160, 190, 255, 0.35);
        --text: #e7eefc;
        --muted: #91a3c7;
        --accent: #49d2ff;
        --danger: #ff6f75;
      }

      * {
        box-sizing: border-box;
      }

      html,
      body {
        margin: 0;
        width: 100%;
        height: 100%;
        background: radial-gradient(circle at 18% 14%, #12335f, #06080f 42%);
        color: var(--text);
        font-family: "Segoe UI", "SF Pro Text", "Helvetica Neue", Arial, sans-serif;
      }

      #ui {
        position: fixed;
        top: 16px;
        left: 16px;
        z-index: 10;
        width: min(560px, calc(100vw - 32px));
        border: 1px solid var(--line);
        border-radius: 14px;
        background: var(--panel);
        backdrop-filter: blur(10px);
        padding: 14px;
        box-shadow: 0 14px 40px rgba(0, 0, 0, 0.35);
      }

      .title {
        margin: 0 0 8px;
        font-size: 18px;
        font-weight: 700;
        letter-spacing: 0.02em;
      }

      .row {
        display: flex;
        gap: 8px;
        width: 100%;
        margin-bottom: 8px;
        flex-wrap: wrap;
      }

      input[type="url"] {
        flex: 1;
        min-width: 260px;
        background: rgba(7, 12, 22, 0.85);
        border: 1px solid rgba(130, 164, 240, 0.35);
        color: var(--text);
        padding: 10px;
        border-radius: 8px;
        font-size: 14px;
      }

      button,
      .file-label {
        border: 1px solid rgba(137, 193, 255, 0.6);
        border-radius: 8px;
        background: linear-gradient(180deg, #1d3f69, #17335a);
        color: #eaf4ff;
        font-weight: 600;
        font-size: 13px;
        padding: 9px 12px;
        cursor: pointer;
      }

      button:hover,
      .file-label:hover {
        border-color: var(--accent);
      }

      button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }

      .subtle {
        margin: 6px 0 0;
        color: var(--muted);
        font-size: 13px;
        line-height: 1.35;
      }

      .status {
        margin: 10px 0 0;
        font-size: 13px;
        color: #c4d6ff;
      }

      .status.error {
        color: var(--danger);
      }

      #local-file {
        display: none;
      }

      @media (max-width: 720px) {
        #ui {
          top: 10px;
          left: 10px;
          width: calc(100vw - 20px);
          padding: 12px;
        }

        .title {
          font-size: 16px;
        }
      }
    </style>
  </head>
  <body>
    <section id="ui">
      <h1 class="title">SPZ Viewer for Quest (WebXR VR)</h1>
      <div class="row">
        <input id="url-input" type="url" placeholder="https://example.com/scene.spz" />
        <button id="load-url">Load URL</button>
      </div>
      <div class="row">
        <label class="file-label" for="local-file">Load Local .spz</label>
        <input id="local-file" type="file" accept=".spz" />
        <button id="sample-btn" type="button">Load Sample</button>
      </div>
      <p class="subtle">
        Desktop: drag with mouse + WASD navigation. Quest: use the generated Enter VR button, then headset/controllers for movement.
      </p>
      <p class="subtle" id="compat-note"></p>
      <p id="status" class="status">Initializing viewer...</p>
    </section>

    <script type="module">
      const DEFAULT_SAMPLE = "/splats/ceramic-500k-demo.spz";

      const statusEl = document.getElementById("status");
      const compatEl = document.getElementById("compat-note");
      const urlInput = document.getElementById("url-input");
      const loadUrlBtn = document.getElementById("load-url");
      const sampleBtn = document.getElementById("sample-btn");
      const localFileInput = document.getElementById("local-file");

      const querySource = new URL(window.location.href).searchParams.get("src");
      const initialSource = querySource || DEFAULT_SAMPLE;
      urlInput.value = initialSource;

      let GaussianSplats3D = null;
      let viewer = null;
      let objectUrl = null;

      const updateStatus = (message, isError = false) => {
        statusEl.textContent = message;
        statusEl.classList.toggle("error", isError);
      };

      const setBusy = (busy) => {
        loadUrlBtn.disabled = busy;
        sampleBtn.disabled = busy;
        localFileInput.disabled = busy;
      };

      const setCompatNote = () => {
        const notes = [];
        if (!window.isSecureContext && window.location.hostname !== "localhost") {
          notes.push("WebXR requires HTTPS or localhost.");
        }
        if (!navigator.xr) {
          notes.push("WebXR is unavailable in this browser.");
        }
        compatEl.textContent = notes.join(" ");
      };

      const importLibrary = async () => {
        if (GaussianSplats3D) return GaussianSplats3D;
        updateStatus("Downloading viewer runtime...");
        GaussianSplats3D = await import("https://cdn.jsdelivr.net/npm/@mkkellogg/gaussian-splats-3d@0.4.7/+esm");
        return GaussianSplats3D;
      };

      const destroyViewer = () => {
        if (viewer) {
          viewer.dispose();
          viewer = null;
        }
      };

      const makeViewer = (lib) => {
        destroyViewer();

        viewer = new lib.Viewer({
          cameraUp: [0, 1, 0],
          initialCameraPosition: [0, 1.6, 2.4],
          initialCameraLookAt: [0, 1.3, 0],
          sharedMemoryForWorkers: false,
          inMemoryCompressionLevel: 1,
          webXRMode: lib.WebXRMode.VR,
          webXRSessionInit: {
            optionalFeatures: ["local-floor", "bounded-floor", "hand-tracking"],
          },
        });

        // Uses the library's built-in VR button integration.
        viewer.setVRButtonEnabled(true);
        viewer.start();
      };

      const replaceQuerySource = (source) => {
        const url = new URL(window.location.href);
        url.searchParams.set("src", source);
        history.replaceState(null, "", url);
      };

      const loadScene = async (source) => {
        const trimmed = source.trim();
        if (!trimmed) {
          updateStatus("Provide a valid .spz URL first.", true);
          return;
        }

        setBusy(true);
        updateStatus("Preparing scene...");

        try {
          const lib = await importLibrary();
          makeViewer(lib);
          updateStatus("Streaming SPZ data...");

          await viewer.addSplatScene(trimmed, {
            progressiveLoad: true,
            showLoadingUI: true,
          });

          replaceQuerySource(trimmed);
          updateStatus("Scene loaded. Use Enter VR when ready.");
        } catch (error) {
          console.error(error);
          const message = error instanceof Error ? error.message : "Failed to load scene.";
          updateStatus(`Load failed: ${message}`, true);
        } finally {
          setBusy(false);
        }
      };

      loadUrlBtn.addEventListener("click", () => {
        loadScene(urlInput.value);
      });

      sampleBtn.addEventListener("click", () => {
        urlInput.value = DEFAULT_SAMPLE;
        loadScene(DEFAULT_SAMPLE);
      });

      localFileInput.addEventListener("change", () => {
        const file = localFileInput.files?.[0];
        if (!file) return;

        if (objectUrl) {
          URL.revokeObjectURL(objectUrl);
          objectUrl = null;
        }

        objectUrl = URL.createObjectURL(file);
        urlInput.value = objectUrl;
        loadScene(objectUrl);
      });

      setCompatNote();
      loadScene(initialSource);
    </script>
  </body>
</html>
